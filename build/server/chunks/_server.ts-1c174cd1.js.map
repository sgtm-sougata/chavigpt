{"version":3,"file":"_server.ts-1c174cd1.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/conversation/_id_/share/_server.ts.js"],"sourcesContent":["import { s as sha256, a as authCondition } from \"../../../../../chunks/auth.js\";\nimport { c as collections } from \"../../../../../chunks/database.js\";\nimport { b as base } from \"../../../../../chunks/paths.js\";\nimport { e as error } from \"../../../../../chunks/index.js\";\nimport { ObjectId } from \"mongodb\";\nimport { nanoid } from \"nanoid\";\nfunction getShareUrl(url, shareId) {\n  return `${`${url.origin}${base}`}/r/${shareId}`;\n}\nasync function hashConv(conv) {\n  const messages = conv.messages.map((message) => {\n    return (({ from, id, content, webSearchId }) => ({ from, id, content, webSearchId }))(message);\n  });\n  const hash = await sha256(JSON.stringify(messages));\n  return hash;\n}\nasync function POST({ params, url, locals }) {\n  const conversation = await collections.conversations.findOne({\n    _id: new ObjectId(params.id),\n    ...authCondition(locals)\n  });\n  if (!conversation) {\n    throw error(404, \"Conversation not found\");\n  }\n  const hash = await hashConv(conversation);\n  const existingShare = await collections.sharedConversations.findOne({ hash });\n  if (existingShare) {\n    return new Response(\n      JSON.stringify({\n        url: getShareUrl(url, existingShare._id)\n      }),\n      { headers: { \"Content-Type\": \"application/json\" } }\n    );\n  }\n  const shared = {\n    _id: nanoid(7),\n    createdAt: /* @__PURE__ */ new Date(),\n    messages: conversation.messages,\n    hash,\n    updatedAt: /* @__PURE__ */ new Date(),\n    title: conversation.title,\n    model: conversation.model,\n    preprompt: conversation.preprompt\n  };\n  await collections.sharedConversations.insertOne(shared);\n  const files = await collections.bucket.find({ filename: { $regex: `${conversation._id}-` } }).toArray();\n  await Promise.all(\n    files.map(async (file) => {\n      const newFilename = file.filename.replace(`${conversation._id}-`, `${shared._id}-`);\n      const downloadStream = collections.bucket.openDownloadStream(file._id);\n      const uploadStream = collections.bucket.openUploadStream(newFilename, {\n        metadata: { ...file.metadata, conversation: shared._id.toString() }\n      });\n      downloadStream.pipe(uploadStream);\n    })\n  );\n  return new Response(\n    JSON.stringify({\n      url: getShareUrl(url, shared._id)\n    }),\n    { headers: { \"Content-Type\": \"application/json\" } }\n  );\n}\nexport {\n  POST\n};\n"],"names":[],"mappings":";;;;;;;;;;;;AAMA,SAAS,WAAW,CAAC,GAAG,EAAE,OAAO,EAAE;AACnC,EAAE,OAAO,CAAC,EAAE,CAAC,EAAE,GAAG,CAAC,MAAM,CAAC,EAAE,IAAI,CAAC,CAAC,CAAC,GAAG,EAAE,OAAO,CAAC,CAAC,CAAC;AAClD,CAAC;AACD,eAAe,QAAQ,CAAC,IAAI,EAAE;AAC9B,EAAE,MAAM,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,OAAO,KAAK;AAClD,IAAI,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,EAAE,EAAE,OAAO,EAAE,WAAW,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,EAAE,OAAO,EAAE,WAAW,EAAE,CAAC,EAAE,OAAO,CAAC,CAAC;AACnG,GAAG,CAAC,CAAC;AACL,EAAE,MAAM,IAAI,GAAG,MAAM,MAAM,CAAC,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,CAAC,CAAC;AACtD,EAAE,OAAO,IAAI,CAAC;AACd,CAAC;AACD,eAAe,IAAI,CAAC,EAAE,MAAM,EAAE,GAAG,EAAE,MAAM,EAAE,EAAE;AAC7C,EAAE,MAAM,YAAY,GAAG,MAAM,WAAW,CAAC,aAAa,CAAC,OAAO,CAAC;AAC/D,IAAI,GAAG,EAAE,IAAI,QAAQ,CAAC,MAAM,CAAC,EAAE,CAAC;AAChC,IAAI,GAAG,aAAa,CAAC,MAAM,CAAC;AAC5B,GAAG,CAAC,CAAC;AACL,EAAE,IAAI,CAAC,YAAY,EAAE;AACrB,IAAI,MAAM,KAAK,CAAC,GAAG,EAAE,wBAAwB,CAAC,CAAC;AAC/C,GAAG;AACH,EAAE,MAAM,IAAI,GAAG,MAAM,QAAQ,CAAC,YAAY,CAAC,CAAC;AAC5C,EAAE,MAAM,aAAa,GAAG,MAAM,WAAW,CAAC,mBAAmB,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,CAAC,CAAC;AAChF,EAAE,IAAI,aAAa,EAAE;AACrB,IAAI,OAAO,IAAI,QAAQ;AACvB,MAAM,IAAI,CAAC,SAAS,CAAC;AACrB,QAAQ,GAAG,EAAE,WAAW,CAAC,GAAG,EAAE,aAAa,CAAC,GAAG,CAAC;AAChD,OAAO,CAAC;AACR,MAAM,EAAE,OAAO,EAAE,EAAE,cAAc,EAAE,kBAAkB,EAAE,EAAE;AACzD,KAAK,CAAC;AACN,GAAG;AACH,EAAE,MAAM,MAAM,GAAG;AACjB,IAAI,GAAG,EAAE,MAAM,CAAC,CAAC,CAAC;AAClB,IAAI,SAAS,kBAAkB,IAAI,IAAI,EAAE;AACzC,IAAI,QAAQ,EAAE,YAAY,CAAC,QAAQ;AACnC,IAAI,IAAI;AACR,IAAI,SAAS,kBAAkB,IAAI,IAAI,EAAE;AACzC,IAAI,KAAK,EAAE,YAAY,CAAC,KAAK;AAC7B,IAAI,KAAK,EAAE,YAAY,CAAC,KAAK;AAC7B,IAAI,SAAS,EAAE,YAAY,CAAC,SAAS;AACrC,GAAG,CAAC;AACJ,EAAE,MAAM,WAAW,CAAC,mBAAmB,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC;AAC1D,EAAE,MAAM,KAAK,GAAG,MAAM,WAAW,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE,QAAQ,EAAE,EAAE,MAAM,EAAE,CAAC,EAAE,YAAY,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,OAAO,EAAE,CAAC;AAC1G,EAAE,MAAM,OAAO,CAAC,GAAG;AACnB,IAAI,KAAK,CAAC,GAAG,CAAC,OAAO,IAAI,KAAK;AAC9B,MAAM,MAAM,WAAW,GAAG,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC,EAAE,YAAY,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;AAC1F,MAAM,MAAM,cAAc,GAAG,WAAW,CAAC,MAAM,CAAC,kBAAkB,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;AAC7E,MAAM,MAAM,YAAY,GAAG,WAAW,CAAC,MAAM,CAAC,gBAAgB,CAAC,WAAW,EAAE;AAC5E,QAAQ,QAAQ,EAAE,EAAE,GAAG,IAAI,CAAC,QAAQ,EAAE,YAAY,EAAE,MAAM,CAAC,GAAG,CAAC,QAAQ,EAAE,EAAE;AAC3E,OAAO,CAAC,CAAC;AACT,MAAM,cAAc,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;AACxC,KAAK,CAAC;AACN,GAAG,CAAC;AACJ,EAAE,OAAO,IAAI,QAAQ;AACrB,IAAI,IAAI,CAAC,SAAS,CAAC;AACnB,MAAM,GAAG,EAAE,WAAW,CAAC,GAAG,EAAE,MAAM,CAAC,GAAG,CAAC;AACvC,KAAK,CAAC;AACN,IAAI,EAAE,OAAO,EAAE,EAAE,cAAc,EAAE,kBAAkB,EAAE,EAAE;AACvD,GAAG,CAAC;AACJ;;;;"}