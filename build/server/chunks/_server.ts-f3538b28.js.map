{"version":3,"file":"_server.ts-f3538b28.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/conversation/_server.ts.js"],"sourcesContent":["import { c as collections } from \"../../../chunks/database.js\";\nimport { ObjectId } from \"mongodb\";\nimport { e as error, r as redirect } from \"../../../chunks/index.js\";\nimport { b as base } from \"../../../chunks/paths.js\";\nimport { z } from \"zod\";\nimport { v as validateModel, m as models } from \"../../../chunks/models.js\";\nconst POST = async ({ locals, request }) => {\n  const body = await request.text();\n  let title = \"\";\n  let messages = [];\n  const values = z.object({\n    fromShare: z.string().optional(),\n    model: validateModel(models),\n    preprompt: z.string().optional()\n  }).parse(JSON.parse(body));\n  let preprompt = values.preprompt;\n  if (values.fromShare) {\n    const conversation = await collections.sharedConversations.findOne({\n      _id: values.fromShare\n    });\n    if (!conversation) {\n      throw error(404, \"Conversation not found\");\n    }\n    title = conversation.title;\n    messages = conversation.messages;\n    values.model = conversation.model;\n    preprompt = conversation.preprompt;\n  }\n  const model = models.find((m) => m.name === values.model);\n  if (!model) {\n    throw error(400, \"Invalid model\");\n  }\n  if (model.unlisted) {\n    throw error(400, \"Can't start a conversation with an unlisted model\");\n  }\n  preprompt = preprompt === void 0 ? model?.preprompt : preprompt;\n  const res = await collections.conversations.insertOne({\n    _id: new ObjectId(),\n    title: title || \"New Chat\",\n    messages,\n    model: values.model,\n    preprompt: preprompt === model?.preprompt ? model?.preprompt : preprompt,\n    createdAt: /* @__PURE__ */ new Date(),\n    updatedAt: /* @__PURE__ */ new Date(),\n    ...locals.user ? { userId: locals.user._id } : { sessionId: locals.sessionId },\n    ...values.fromShare ? { meta: { fromShareId: values.fromShare } } : {}\n  });\n  return new Response(\n    JSON.stringify({\n      conversationId: res.insertedId.toString()\n    }),\n    { headers: { \"Content-Type\": \"application/json\" } }\n  );\n};\nconst GET = async () => {\n  throw redirect(302, `${base}/`);\n};\nexport {\n  GET,\n  POST\n};\n"],"names":[],"mappings":"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"}