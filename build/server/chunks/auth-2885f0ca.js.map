{"version":3,"file":"auth-2885f0ca.js","sources":["../../../.svelte-kit/adapter-node/chunks/auth.js"],"sourcesContent":["import { Issuer, custom } from \"openid-client\";\nimport { addWeeks, addHours } from \"date-fns\";\nimport { f as OPENID_CONFIG, g as OPENID_CLIENT_ID, h as OPENID_CLIENT_SECRET, i as OPENID_PROVIDER_URL, j as OPENID_SCOPES, k as OPENID_TOLERANCE, l as OPENID_RESOURCE, C as COOKIE_NAME, c as collections } from \"./database.js\";\nimport { z } from \"zod\";\nimport { d as dev } from \"./environment.js\";\nasync function sha256(input) {\n  const utf8 = new TextEncoder().encode(input);\n  const hashBuffer = await crypto.subtle.digest(\"SHA-256\", utf8);\n  const hashArray = Array.from(new Uint8Array(hashBuffer));\n  const hashHex = hashArray.map((bytes) => bytes.toString(16).padStart(2, \"0\")).join(\"\");\n  return hashHex;\n}\nconst stringWithDefault = (value) => z.string().default(value).transform((el) => el ? el : value);\nconst OIDConfig = z.object({\n  CLIENT_ID: stringWithDefault(OPENID_CLIENT_ID),\n  CLIENT_SECRET: stringWithDefault(OPENID_CLIENT_SECRET),\n  PROVIDER_URL: stringWithDefault(OPENID_PROVIDER_URL),\n  SCOPES: stringWithDefault(OPENID_SCOPES),\n  TOLERANCE: stringWithDefault(OPENID_TOLERANCE),\n  RESOURCE: stringWithDefault(OPENID_RESOURCE)\n}).parse(JSON.parse(OPENID_CONFIG));\nconst requiresUser = !!OIDConfig.CLIENT_ID && !!OIDConfig.CLIENT_SECRET;\nfunction refreshSessionCookie(cookies, sessionId) {\n  cookies.set(COOKIE_NAME, sessionId, {\n    path: \"/\",\n    // So that it works inside the space's iframe\n    sameSite: \"none\",\n    secure: !dev,\n    httpOnly: true,\n    expires: addWeeks(/* @__PURE__ */ new Date(), 2)\n  });\n}\nasync function findUser(sessionId) {\n  const session = await collections.sessions.findOne({ sessionId });\n  if (!session) {\n    return null;\n  }\n  return await collections.users.findOne({ _id: session.userId });\n}\nconst authCondition = (locals) => {\n  return locals.user ? { userId: locals.user._id } : { sessionId: locals.sessionId, userId: { $exists: false } };\n};\nasync function generateCsrfToken(sessionId, redirectUrl) {\n  const data = {\n    expiration: addHours(/* @__PURE__ */ new Date(), 1).getTime(),\n    redirectUrl\n  };\n  return Buffer.from(\n    JSON.stringify({\n      data,\n      signature: await sha256(JSON.stringify(data) + \"##\" + sessionId)\n    })\n  ).toString(\"base64\");\n}\nasync function getOIDCClient(settings) {\n  const issuer = await Issuer.discover(OIDConfig.PROVIDER_URL);\n  return new issuer.Client({\n    client_id: OIDConfig.CLIENT_ID,\n    client_secret: OIDConfig.CLIENT_SECRET,\n    redirect_uris: [settings.redirectURI],\n    response_types: [\"code\"],\n    [custom.clock_tolerance]: OIDConfig.TOLERANCE || void 0\n  });\n}\nasync function getOIDCAuthorizationUrl(settings, params) {\n  const client = await getOIDCClient(settings);\n  const csrfToken = await generateCsrfToken(params.sessionId, settings.redirectURI);\n  return client.authorizationUrl({\n    scope: OIDConfig.SCOPES,\n    state: csrfToken,\n    resource: OIDConfig.RESOURCE || void 0\n  });\n}\nasync function getOIDCUserData(settings, code) {\n  const client = await getOIDCClient(settings);\n  const token = await client.callback(settings.redirectURI, { code });\n  const userData = await client.userinfo(token);\n  return { token, userData };\n}\nasync function validateAndParseCsrfToken(token, sessionId) {\n  try {\n    const { data, signature } = z.object({\n      data: z.object({\n        expiration: z.number().int(),\n        redirectUrl: z.string().url()\n      }),\n      signature: z.string().length(64)\n    }).parse(JSON.parse(token));\n    const reconstructSign = await sha256(JSON.stringify(data) + \"##\" + sessionId);\n    if (data.expiration > Date.now() && signature === reconstructSign) {\n      return { redirectUrl: data.redirectUrl };\n    }\n  } catch (e) {\n    console.error(e);\n  }\n  return null;\n}\nexport {\n  authCondition as a,\n  refreshSessionCookie as b,\n  getOIDCUserData as c,\n  findUser as f,\n  getOIDCAuthorizationUrl as g,\n  requiresUser as r,\n  sha256 as s,\n  validateAndParseCsrfToken as v\n};\n"],"names":[],"mappings":"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"}