import{_ as me}from"../chunks/preload-helper.41c905a7.js";import{s as pe,v as B,j as he,a as ue,U as ge,k as we,g as D,c as _e,m as j,F as ye,i as be,Z as V,f as Se,b as Me,M as k,o as Ee,W as h}from"../chunks/boolean_attributes.9921dbdc.js";import{S as ke,i as Ae,b as Z,c as Ce,a as Oe,m as Te,d as Pe}from"../chunks/index.369f2cd8.js";import{f as Q,C as Ue,p as Y,w as Ie,a as Le,r as W}from"../chunks/pendingMessage.3a5bb898.js";import{s as Re,i as N,t as v,U as x}from"../chunks/titleUpdate.b9dbf5b1.js";import{p as je}from"../chunks/stores.acee8332.js";import{g as $,i as ee}from"../chunks/close.b8c63ca1.js";import{e as U}from"../chunks/singletons.87a67235.js";import{e as u,E as X}from"../chunks/Logo.1e236891.js";function Ne(r){let _,t,y,a,m,p,l;document.title=_=r[7];function A(e){r[13](e)}function I(e){r[14](e)}let i={loading:r[4],pending:r[5],messages:r[2],shared:r[0].shared,preprompt:r[0].preprompt,models:r[0].models,currentModel:Q([...r[0].models,...r[0].oldModels],r[0].model)};return r[3]!==void 0&&(i.webSearchMessages=r[3]),r[6]!==void 0&&(i.files=r[6]),a=new Ue({props:i}),B.push(()=>Z(a,"webSearchMessages",A)),B.push(()=>Z(a,"files",I)),a.$on("message",r[10]),a.$on("retry",r[11]),a.$on("vote",r[15]),a.$on("share",r[16]),a.$on("stop",r[17]),{c(){t=he("link"),y=ue(),Ce(a.$$.fragment),this.h()},l(e){const n=ge("svelte-626amo",document.head);t=we(n,"LINK",{rel:!0,href:!0,integrity:!0,crossorigin:!0}),n.forEach(D),y=_e(e),Oe(a.$$.fragment,e),this.h()},h(){j(t,"rel","stylesheet"),j(t,"href","https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css"),j(t,"integrity","sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn"),j(t,"crossorigin","anonymous")},m(e,n){ye(document.head,t),be(e,y,n),Te(a,e,n),l=!0},p(e,[n]){(!l||n&128)&&_!==(_=e[7])&&(document.title=_);const c={};n&16&&(c.loading=e[4]),n&32&&(c.pending=e[5]),n&4&&(c.messages=e[2]),n&1&&(c.shared=e[0].shared),n&1&&(c.preprompt=e[0].preprompt),n&1&&(c.models=e[0].models),n&1&&(c.currentModel=Q([...e[0].models,...e[0].oldModels],e[0].model)),!m&&n&8&&(m=!0,c.webSearchMessages=e[3],V(()=>m=!1)),!p&&n&64&&(p=!0,c.files=e[6],V(()=>p=!1)),a.$set(c)},i(e){l||(Se(a.$$.fragment,e),l=!0)},o(e){Me(a.$$.fragment,e),l=!1},d(e){e&&D(y),D(t),Pe(a,e)}}}function Je(r,_,t){let y,a,m,p,l,A,I;k(r,je,s=>t(1,a=s)),k(r,N,s=>t(8,m=s)),k(r,Y,s=>t(18,p=s)),k(r,u,s=>t(19,l=s)),k(r,v,s=>t(20,A=s)),k(r,Ie,s=>t(21,I=s));let{data:i}=_,e=i.messages,n=i.messages,c=[],g=!1,C=!1,b=[];async function G(){try{t(4,g=!0);const s=await fetch(`${U}/conversation`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fromShare:a.params.id,model:i.model})});if(!s.ok){u.set("Error while creating conversation, try again."),console.error("Error while creating conversation: "+await s.text());return}const{conversationId:d}=await s.json();return d}catch(s){throw u.set(X.default),console.error(String(s)),s}}async function O(s,d=W()){var L,T;if(s.trim())try{h(N,m=!1,m),t(4,g=!0),t(5,C=!0);let o=e.findIndex(S=>S.id===d);const R=o!==-1;R||(o=e.length);const le=await me(()=>import("../chunks/index.8a46ea8d.js").then(S=>S.i),["../chunks/index.8a46ea8d.js","../chunks/_commonjsHelpers.39b5b250.js"],import.meta.url),F=await Promise.all(b.map(async S=>await le.readAndCompressImage(S,{maxHeight:224,maxWidth:224,quality:1}).then(async E=>await Le(E))));t(2,e=[...e.slice(0,o),{from:"user",content:s,id:d,files:R?e[o].files:F}]),t(6,b=[]);const ce=W(),M=await fetch(`${U}/conversation/${a.params.id}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({inputs:s,id:d,response_id:ce,is_retry:R,web_search:I.useSearch,files:R?void 0:F})});if(t(6,b=[]),!M.body)throw new Error("Body not defined");if(!M.ok){u.set((L=await M.json())==null?void 0:L.message);return}const fe=new TextDecoderStream,w=(T=M==null?void 0:M.body)==null?void 0:T.pipeThrough(fe).getReader();let K="",z=[""];for(;K==="";){if(m){w==null||w.cancel();break}await(w==null?void 0:w.read().then(async({done:S,value:E})=>{if(S){w.cancel();return}if(!E)return;E=z.pop()+E;const J=E.split(`
`);J.forEach(async q=>{try{const f=JSON.parse(q);if(f.type==="finalAnswer")K=f.text,w.cancel(),t(4,g=!1),t(5,C=!1),ee(x.Conversation);else if(f.type==="stream"){t(5,C=!1);let P=e[e.length-1];P.from!=="assistant"?t(2,e=[...e,{from:"assistant",id:W(),content:f.token}]):(P.content+=f.token,t(2,e=[...e]))}else if(f.type==="webSearch")t(3,c=[...c,f]);else if(f.type==="status")if(f.status==="title"&&f.message){const P=i.conversations.find(({id:de})=>de===a.params.id);P&&(P.title=f.message,h(v,A={title:f.message,convId:a.params.id},A))}else f.status==="error"&&h(u,l=f.message??"An error has occurred",l);else f.type==="error"&&(u.set(f.message),w.cancel())}catch{q===J[J.length-1]&&z.push(q);return}})}))}t(3,c=[]),await ee(x.ConversationList)}catch(o){o instanceof Error&&o.message.includes("overloaded")?h(u,l="Too much traffic, please try again.",l):o instanceof Error&&o.message.includes("429")?h(u,l=X.rateLimited,l):o instanceof Error?h(u,l=o.message,l):h(u,l=X.default,l),console.error(o)}finally{t(4,g=!1),t(5,C=!1)}}async function H(s,d){let L=a.params.id,T;t(2,e=e.map(o=>o.id===d?(T=o.score,{...o,score:s}):o));try{await fetch(`${U}/conversation/${L}/message/${d}/vote`,{method:"POST",body:JSON.stringify({score:s})})}catch{t(2,e=e.map(o=>o.id!==d?o:{...o,score:T}))}}Ee(async()=>{p&&(t(6,b=p.files),await O(p.content),h(Y,p=void 0,p))});async function se(s){i.shared?G().then(async d=>{await $(`${U}/conversation/${d}`,{invalidateAll:!0})}).then(()=>O(s.detail)).finally(()=>t(4,g=!1)):O(s.detail)}async function te(s){i.shared?G().then(async d=>{await $(`${U}/conversation/${d}`,{invalidateAll:!0})}).then(()=>O(s.detail.content,s.detail.id)).finally(()=>t(4,g=!1)):O(s.detail.content,s.detail.id)}function re(s){c=s,t(3,c)}function ae(s){b=s,t(6,b)}const oe=s=>H(s.detail.score,s.detail.id),ne=()=>Re(a.params.id,i.title),ie=()=>(h(N,m=!0,m),t(4,g=!1));return r.$$set=s=>{"data"in s&&t(0,i=s.data)},r.$$.update=()=>{var s;r.$$.dirty&4097&&i.messages!==n&&(t(2,e=i.messages),t(12,n=i.messages)),r.$$.dirty&2&&(a.params.id,h(N,m=!0,m),t(4,g=!1)),r.$$.dirty&3&&t(7,y=((s=i.conversations.find(d=>d.id===a.params.id))==null?void 0:s.title)??i.title)},[i,a,e,c,g,C,b,y,m,H,se,te,n,re,ae,oe,ne,ie]}class Be extends ke{constructor(_){super(),Ae(this,_,Je,Ne,pe,{data:0})}}export{Be as component};
